"use strict";(self.webpackChunkwasm_vgm_player=self.webpackChunkwasm_vgm_player||[]).push([[269],{269:(e,t,n)=>{n.r(t);var r,a,o,i,l,c,u,f,_,s,d,g,m,h,y,p,w,v=n(944),k=n(629),b=768,x=576,A="#00a040",T="#e60012",E="16px sans-serif",j=null,M=[],P=44100,C=null,D=null,S=null;(y=document.getElementById("screen")).setAttribute("width",b),y.setAttribute("height",x),(window.devicePixelRatio?window.devicePixelRatio:1)>1&&window.screen.width<b&&(y.style.width="320px",y.style.heigth="240px"),p=y.getContext("2d"),function(){if(""!=location.hash){var e=location.hash.match(/^#s=(\d+)/);null!=e&&((P=parseInt(e[1]))!=P||44100!=P&&48e3!=P&&88200!=P&&96e3!=P)&&(P=44100)}}(),w=(C=new(window.AudioContext||window.webkitAudioContext)({sampleRate:P})).createScriptProcessor(0,2,2),o=w?w.bufferSize:2048,C=null,i=2*P/o,fetch("./vgm/ym2612.vgm").then((function(e){return e.arrayBuffer()})).then((function(e){V(e)})).then((function(){y.addEventListener("click",I,!1),y.addEventListener("dragover",(function(e){return R(e),y.style.border="4px dotted #333333",!1}),!1),y.addEventListener("dragleave",(function(e){return R(e),y.style.border="none",!1})),y.addEventListener("drop",O,!1),r=1,a=F({track_name:"WebAssembly ðŸ‘¾ VGM Player",track_name_j:"",game_name:"",game_name_j:"YM2612 sample VGM",track_author:"@h1romas4",track_author_j:""}),L()}));var q=function(e,t){var n=(b-p.measureText(e).width)/2;p.fillText(e,n,t)},L=function(){p.fillStyle="rgb(0, 0, 0)",p.fillRect(0,0,b,x),p.font="bold 28px sans-serif",p.fillStyle=T,q("WebAssembly ðŸŽ® VGM Player",160),p.fillStyle=A,p.font="15px sans-serif",q("YM2151 | YM2203 | YM2149 | YM2413 | YM2612 | SN76489(MD) | PWM(32x) | SEGAPCM",224),p.font="20px sans-serif",q("ðŸŽµ DRAG AND DROP VGM(vgm/vgz) HEAR",256),q("OR CLICK(TAP) TO PLAY SAMPLE VGM",320),U()},R=function(e){e.preventDefault(),e.stopPropagation()},O=function e(t){R(t),y.removeEventListener("drop",e,!1),y.style.border="none";var n={},a=t.dataTransfer.files;return[].forEach.call(a,(function(t){var o=new FileReader;o.onload=function(){n[t.name]=o.result,Object.keys(n).length>=a.length&&(y.addEventListener("drop",e,!1),M=[],Object.keys(n).sort().forEach((function(e){M.push(n[e])})),r=M.length,B())},o.readAsArrayBuffer(t)})),!1},B=function e(){M.length<=0||(V(M.shift())?I():e())},F=function(e){return e.game_track_name=[e.game_name,e.track_name].filter((function(e){return""!=e})).join(" | "),e.game_track_name_j=[e.game_name_j,e.track_name_j].filter((function(e){return""!=e})).join(" / "),e.track_author_full=[e.track_author,e.track_author_j].filter((function(e){return""!=e})).join(" - "),p.font=E,e.game_track_name_left=(b-p.measureText(e.game_track_name).width)/2,e.game_track_name_j_left=(b-p.measureText(e.game_track_name_j).width)/2,e.track_author_full_left=(b-p.measureText(e.track_author_full).width)/2,e},V=function(e){if(null!=j&&j.free(),j=new k.n9(P,o,e.byteLength),new Uint8Array(v.memory.buffer,j.get_seq_data_ref(),e.byteLength).set(new Uint8Array(e)),!j.init())return j.free(),!1;a=F(JSON.parse(j.get_seq_gd3())),_=[],s=[],g=0,m=0,h=0;var t=!1,n=0;d=!1;var r=setInterval((function(){var e;t&&clearInterval(r);try{if(_.length<10&&!t){e=j.play();var a=new Float32Array(o),l=new Float32Array(o);a.set(new Float32Array(v.memory.buffer,j.get_sampling_l_ref(),o)),l.set(new Float32Array(v.memory.buffer,j.get_sampling_r_ref(),o)),_.push(a),s.push(l),_.length>=10&&(d=!0),e>=2&&(0==n&&e>2?t=!0:(0==n&&(h=m),++n>i&&(t=!0))),m++}}catch(e){alert("ymfm:\n\nAn unexpected error has occurred. System has stoped. Please reload brwoser.\n\n".concat(e)),t=!0}}),o/P/4*1e3);return!0},G=function(){null!=c&&c.disconnect(),null!=l&&l.disconnect(),null!=D&&D.disconnect(),c=null,D=null,l=null},I=function e(){y.removeEventListener("click",e,!1),G(),null==C&&(C=new(window.AudioContext||window.webkitAudioContext)({sampleRate:P})),(D=C.createScriptProcessor(o,2,2)).onaudioprocess=function(e){1==d&&_.length>0?(e.outputBuffer.getChannelData(0).set(_[0]),e.outputBuffer.getChannelData(1).set(s[0]),_.shift(),s.shift(),g==h&&(l.gain.setValueAtTime(1,C.currentTime),l.gain.linearRampToValueAtTime(0,C.currentTime+2)),g++):1==d&&0==_.length&&(G(),B())},l=C.createGain(),D.connect(l),l.connect(C.destination),l.gain.setValueAtTime(1,C.currentTime),c=C.createAnalyser(),f=c.frequencyBinCount,u=new Uint8Array(f),c.getByteTimeDomainData(u),l.connect(c),null!=S&&(window.cancelAnimationFrame(S),S=null),Y()},Y=function e(){if(S=window.requestAnimationFrame(e),p.fillStyle="rgb(0, 0, 0)",p.fillRect(0,0,b,x),null!=c){c.getByteFrequencyData(u),p.lineWidth=1,p.beginPath(),p.strokeStyle=T;var t=Math.round(f/192);p.setLineDash([2,1]),p.lineWidth=4;for(var n=0;n<f;n+=t)p.beginPath(),p.moveTo(n+2,x),p.lineTo(n+2,x-1.5*u[n]),p.stroke();p.stroke()}p.font="12px monospace",p.fillStyle=A,r>=1&&q("Track "+(r-M.length)+" / "+r,192),p.font=E,p.fillText(a.game_track_name,a.game_track_name_left,224),p.fillText(a.game_track_name_j,a.game_track_name_j_left,256),p.fillText(a.track_author_full,a.track_author_full_left,288),U()},U=function(){if(44100!=P){var e=" HD:"+P+" ";p.font="16px sans-serif";var t=p.measureText(e);p.fillStyle=A,p.fillRect(b-t.width,0,b,18),p.fillStyle="rgb(0, 0, 0)",p.fillText(e,b-t.width,16)}}},913:(e,t,n)=>{n.d(t,{Cf:()=>r,UX:()=>a,yU:()=>o,Vn:()=>i,lO:()=>l,NM:()=>c,H4:()=>u});var r=function(e,t,n,r){console.log("fd_seek: ".concat(e,", ").concat(t,", ").concat(n,", ").concat(r))},a=function(e,t,n,r){console.log("fd_write: ".concat(e,", ").concat(t,", ").concat(n,", ").concat(r))},o=function(e){console.log("fd_close: ".concat(e))},i=function(e,t){console.log("environ_sizes_get: ".concat(e,", ").concat(t))},l=function(e){console.log("proc_exit: ".concat(e))},c=function(e,t){console.log("environ_get: ".concat(e,", ").concat(t))},u=function(e,t){return console.log("random_get: ".concat(e,", ").concat(t)),0}},629:(e,t,n)=>{n.d(t,{n9:()=>y,h9:()=>p,Dz:()=>w,kF:()=>v,ug:()=>k,Or:()=>b});var r=n(944);function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e=n.hmd(e);var o=new Array(32).fill(void 0);function i(e){return o[e]}o.push(void 0,null,!0,!1);var l=o.length;var c=new("undefined"==typeof TextDecoder?(0,e.require)("util").TextDecoder:TextDecoder)("utf-8",{ignoreBOM:!0,fatal:!0});c.decode();var u=null;function f(){return null!==u&&u.buffer===r.memory.buffer||(u=new Uint8Array(r.memory.buffer)),u}function _(e,t){return c.decode(f().subarray(e,e+t))}var s=null;function d(){return null!==s&&s.buffer===r.memory.buffer||(s=new Int32Array(r.memory.buffer)),s}var g=0,m=new("undefined"==typeof TextEncoder?(0,e.require)("util").TextEncoder:TextEncoder)("utf-8"),h="function"==typeof m.encodeInto?function(e,t){return m.encodeInto(e,t)}:function(e,t){var n=m.encode(e);return t.set(n),{read:e.length,written:n.length}},y=function(){function e(t,n,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var o=r.wgmplay_from(t,n,a);return e.__wrap(o)}var t,n,o;return t=e,o=[{key:"__wrap",value:function(t){var n=Object.create(e.prototype);return n.ptr=t,n}}],(n=[{key:"__destroy_into_raw",value:function(){var e=this.ptr;return this.ptr=0,e}},{key:"free",value:function(){var e=this.__destroy_into_raw();r.__wbg_wgmplay_free(e)}},{key:"get_seq_data_ref",value:function(){return r.wgmplay_get_seq_data_ref(this.ptr)}},{key:"get_sampling_l_ref",value:function(){return r.wgmplay_get_sampling_l_ref(this.ptr)}},{key:"get_sampling_r_ref",value:function(){return r.wgmplay_get_sampling_r_ref(this.ptr)}},{key:"get_seq_header",value:function(){try{var e=r.__wbindgen_add_to_stack_pointer(-16);r.wgmplay_get_seq_header(e,this.ptr);var t=d()[e/4+0],n=d()[e/4+1];return _(t,n)}finally{r.__wbindgen_add_to_stack_pointer(16),r.__wbindgen_free(t,n)}}},{key:"get_seq_gd3",value:function(){try{var e=r.__wbindgen_add_to_stack_pointer(-16);r.wgmplay_get_seq_gd3(e,this.ptr);var t=d()[e/4+0],n=d()[e/4+1];return _(t,n)}finally{r.__wbindgen_add_to_stack_pointer(16),r.__wbindgen_free(t,n)}}},{key:"init",value:function(){return 0!==r.wgmplay_init(this.ptr)}},{key:"play",value:function(){return r.wgmplay_play(this.ptr)>>>0}}])&&a(t.prototype,n),o&&a(t,o),e}();function p(){return function(e){l===o.length&&o.push(o.length+1);var t=l;return l=o[t],o[t]=e,t}(new Error)}function w(e,t){var n=function(e,t,n){if(void 0===n){var r=m.encode(e),a=t(r.length);return f().subarray(a,a+r.length).set(r),g=r.length,a}for(var o=e.length,i=t(o),l=f(),c=0;c<o;c++){var u=e.charCodeAt(c);if(u>127)break;l[i+c]=u}if(c!==o){0!==c&&(e=e.slice(c)),i=n(i,o,o=c+3*e.length);var _=f().subarray(i+c,i+o);c+=h(e,_).written}return g=c,i}(i(t).stack,r.__wbindgen_malloc,r.__wbindgen_realloc),a=g;d()[e/4+1]=a,d()[e/4+0]=n}function v(e,t){try{console.error(_(e,t))}finally{r.__wbindgen_free(e,t)}}function k(e){var t;i(t=e),function(e){e<36||(o[e]=l,l=e)}(t)}function b(e,t){throw new Error(_(e,t))}},944:(e,t,n)=>{var r=n.w[e.id];e.exports=r,n(913),n(629),r[""]()}}]);